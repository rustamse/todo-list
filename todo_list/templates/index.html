<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-2.2.3.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <title>Иерархичный список задач</title>
    <style>
        input:checked + label {
            text-decoration: line-through;
            color: lightgray;
        }
        
        li:hover .addSubtask {
            visibility: visible;
        }
        
        li.done:hover .addSubtask {
            visibility: hidden;
        }
        
        li:hover {
            color: #1580ff;
        }

        div.templates {
            display: none;
        }
        
        input[readonly] {
            background-color: #fff !important; 
        }
        
        .addSubtask {
            visibility: hidden;
        }        

        .subcheckbox {
            margin: 0px 20px 15px 40px;
        }
        
        .smallLeftMargin {
            margin: 0px 0px 0px 10px;
        }
        
        .bigRightMargin {
            margin: 0px 40px 0px 0px;
        }
                
        .brandColor {
            color: #1580ff;
        }
        
    </style>
</head>

<body>
    <div class="jumbotron">
        <div class="container">
            <div class="row row-header">                
                <div class="col-sm-3 col-md-2">
                    <img src="static/logo.png" class="img-responsive" alt="To-do list logo">
                </div>
                <div class="col-sm-9 col-md-10">
                    <h3 style="color: #1580ff;" >Иерархичный список задач</h3>
                    <div>
                        <form class="form-inline">
                            <div class="form-group">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="copyToClipInput" value="http://todo-list.ru/{{ list }}" readonly >
                                    <span class="input-group-btn" >
                                        <button type="button" class="btn btn-success bigRightMargin" id="copyToClipButton" aria-label="Shared Link" data-toggle="tooltip" data-placement="bottom" title="Скопировать ссылку в буфер обмена" onclick="shareClick();">
                                            <span class="glyphicon glyphicon-link" aria-hidden="true"></span><span class="smallLeftMargin">Поделиться списком</span>
                                        </button>
                                    </span>
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="newListButton" aria-label="New List" data-toggle="tooltip" data-placement="bottom" title="Открыть новый список задач" onclick="newListClick();">
                                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span><span class="smallLeftMargin">Новый список</span>
                                </button>
                            </div>                            
                        </form>
                        
                        
                    </div>                    
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row row-content">
            <div class="col-xs-12">
                <h3>Список задач:</h3>
            </div>
            <div class="col-xs-12">
                <ul class="list-unstyled" id="tasks-ul" name="tasks-ul">
                    {% load subtasks %} {% for task in tasks %} {% get_task_children task %} {% endfor %}
                </ul>
            </div>

            <div class="col-xs-12">
                <div class="input-group">
                    <input type="text" class="form-control" name="taskdescr" id="taskdescr" placeholder="Описание задачи...">
                    <span class="input-group-btn">
                        <button class="btn btn-primary add-btn" type="button" name="add-btn">Добавить задачу</button>
                    </span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <br>
                <p class="text-center brandColor">Сайт изготовлен командой "Иерархичный to-do list"</p>
            </div>
        </div>
    </div>

    <div class="templates">
        <div id="taskTemplate">
            <li>
                <div class="checkbox">
                    <label>
                        <div class="col-xs-6">
                            <input type="checkbox" class="taskCheckbox">
                            <label class="taskTitle"></label>
                        </div>

                        <div class="input-group col-xs-6 addSubtask">
                            <input maxlength="400" type="text" class="form-control taskdescr" name="taskdescr"
                                   placeholder="Описание подзадачи..." />
                            <span class="input-group-btn">
                                <button class="btn btn-primary add-btn" type="button" name="add-btn">Добавить подзадачу</button>
                            </span>
                        </div>
                        <ul class="list-unstyled">

                        </ul>
                    </label>
                </div>
            </li>
        </div>

        <div id="subtaskTemplate">
            <li>
                <div class="checkbox subcheckbox">
                    <label>
                        <input maxlength="400" type="checkbox" class="taskCheckbox">
                        <label class="taskTitle"></label>
                    </label>
                </div>
            </li>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            var addTask = function () {
                var parent = $(this).closest('li');
                var descr = "";
                var parent_id = null;
                var parent_element = $("#tasks-ul");

                if (parent.length != 0) {
                    descr = parent.find(".taskdescr").val();
                    parent_id = parent.attr('data-task-id');
                    parent_element = parent.find('ul');
                } else {
                    descr = $('#taskdescr').val();
                }

                if (!descr || !descr.trim()) {
                    alert("Нельзя добавить задачу без описания!");
                    return;
                }

                var str = '{"Method": "Add", "Param": { "task_title": "' + descr + '", "parent": ' + parent_id + ' } }';

                descr = descr.substr(0, 400);

                $.post("http://todo-list.ru/ajax/", str, function (data) {
                    if (data.Data !== null && data.Data.task_id !== null) {
                        var tid = data.Data.task_id;
                        var li = undefined;

                        if(!parent_id) {

                            li = $($('#taskTemplate').html());

                            li.attr('data-task-id', tid);
                            li.find('.taskCheckbox')[0].id = tid;
                            li.find('.taskTitle').text(descr);

                            li.find('.taskCheckbox').click(doneTask);
                            li.find(".add-btn").click(addTask);

                        } else {

                            var li = $($('#subtaskTemplate').html());

                            li.find('.taskCheckbox')[0].id = tid;
                            li.find('.taskTitle').text(descr);

                        }

                        parent_element.append(li);

                        var el = $('#' + tid);
                        el.click(function () {
                            if ($(this).is(':checked')) {
                                $(this).prop('disabled', true);
                                                            
                                var str = '{"Method": "Check", "Param": { "task_id": "' + this.id + '" } }';

                                $($(this).closest('li')[0]).addClass('done');

                                $.post("http://todo-list.ru/ajax/", str, function (data) {
                                    if (data.Data == true) {
                                        $(this).prop('disabled', true);
                                    }
                                });

                            }
                        });
                    }
                });
            };

            var doneTask = function () {
                if ($(this).is(':checked')) {
                    $(this).prop('disabled', true);

                    var str = '{"Method": "Check", "Param": { "task_id": "' + this.id + '" } }';

                    var doneCheckbox = $($(this).closest('li')[0]);
                    doneCheckbox.addClass('done');
                    
                    doneCheckbox.find('input[type=checkbox]').prop('checked', true);
                    doneCheckbox.find('input[type=checkbox]').prop('disabled', true);

                    $.post("http://todo-list.ru/ajax/", str, function (data) {
                        if (data.Data == true) {
                            $(this).prop('disabled', true);
                        }
                    });

                }
            };

            $(".add-btn").click(addTask);

            $('input[type=checkbox]').click(doneTask);
        });
        
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });
        
        function shareClick() {
            copyToClipboard(document.getElementById("copyToClipInput"));
        };
        
        function newListClick() {
            var uuid = generateUUID();
            var newLocation = 'http://todo-list.ru/' + uuid;
            window.location.href = newLocation;
        };        
        
        function copyToClipboard(elem) {
            // create hidden text element, if it doesn't already exist
            var targetId = "_hiddenCopyText_";
            var isInput = elem.tagName === "INPUT" || elem.tagName === "TEXTAREA";
            var origSelectionStart, origSelectionEnd;
            if (isInput) {
                // can just use the original source element for the selection and copy
                target = elem;
                origSelectionStart = elem.selectionStart;
                origSelectionEnd = elem.selectionEnd;
            } else {
                // must use a temporary form element for the selection and copy
                target = document.getElementById(targetId);
                if (!target) {
                    var target = document.createElement("textarea");
                    target.style.position = "absolute";
                    target.style.left = "-9999px";
                    target.style.top = "0";
                    target.id = targetId;
                    document.body.appendChild(target);
                }
                target.textContent = elem.textContent;
            }
            // select the content
            var currentFocus = document.activeElement;
            target.focus();
            target.setSelectionRange(0, target.value.length);

            // copy the selection
            var succeed;
            try {
                  succeed = document.execCommand("copy");
            } catch(e) {
                succeed = false;
            }
            // restore original focus
            //if (currentFocus && typeof currentFocus.focus === "function") {
            //    currentFocus.focus();
            //}

            //if (isInput) {
            //    // restore prior selection
            //    elem.setSelectionRange(origSelectionStart, origSelectionEnd);
            //} else {
            //    // clear temporary content
            //    target.textContent = "";
            //}
            return succeed;
        };
        
        function generateUUID() {
            var d = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = (d + Math.random()*16)%16 | 0;
                d = Math.floor(d/16);
                return (c=='x' ? r : (r&0x3|0x8)).toString(16);
            });
            return uuid;
        };
        
    </script>
</body>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function () {
            try {
                w.yaCounter36844290 = new Ya.Metrika({
                    id: 36844290,
                    clickmap: true,
                    trackLinks: true,
                    accurateTrackBounce: true
                });
            } catch (e) {}
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () {
                n.parentNode.insertBefore(s, n);
            };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else {
            f();
        }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript data-brackets-id='8053'>
    <div data-brackets-id='8054'><img data-brackets-id='8055' src="https://mc.yandex.ru/watch/36844290" style="position:absolute; left:-9999px;" alt="" /></div>
</noscript>
<!-- /Yandex.Metrika counter -->

</html>